<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Калькулятор FIFO — улучшенный расчёт</title>
  <style>
    body {font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f7f8fa; color:#222; margin:0}
    .container {max-width:420px; margin:20px auto; background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.06); padding:16px}
    h2 {text-align:center; font-size:18px; margin:0 0 12px}
    table {width:100%; border-collapse:collapse; font-size:13px; margin:8px 0 12px}
    th, td {border-bottom:1px solid #eef1f4; padding:6px; text-align:center}
    .purchase {background:#e9f2ff; color:#0649d1; font-weight:600}
    .sale {background:#eaffea; color:#0a7a0a; font-weight:600}
    .transfer {background:#fff5e8; color:#9c6400; font-weight:600}
    .btn {background:#0066ff; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px}
    .btn:active {background:#004bcc}
    .btn-del {background:#ff5a5a; color:#fff; border:none; border-radius:6px; padding:4px 8px; font-size:12px; cursor:pointer}
    .btn-del:active {background:#d02727}
    .result-box {background:#f2f5f9; border-radius:10px; padding:10px; font-size:14px; margin-top:10px}
    input, select {width:100%; padding:8px; border-radius:8px; border:1px solid #cfd6df; margin-bottom:8px; font-size:14px}
    .actions {display:flex; gap:8px; margin-top:10px}
    .actions .btn {flex:1}
    #details {display:none; background:#eef3f9; border-radius:10px; padding:10px; margin-top:10px; font-size:13px; white-space:pre-line}
    .muted {color:#667085; font-size:12px}
    .warn {background:#fff2f0; color:#b42318; border:1px solid #ffccc7; border-radius:8px; padding:8px; margin-top:8px; display:none}
    #inputBlock.hidden {display:none}
  </style>
</head>
<body>
  <div class="container">
    <h2>Калькулятор FIFO</h2>

    <table id="operationsTable">
      <thead>
        <tr><th>#</th><th>Тип</th><th>Кол-во</th><th>Цена</th><th></th></tr>
      </thead>
      <tbody><tr><td colspan="5" class="muted">Нет операций</td></tr></tbody>
    </table>

    <div id="inputBlock">
      <select id="type" onchange="togglePriceField()">
        <option value="Покупка (Приход)">Покупка (Приход)</option>
        <option value="Продажа (Уход)">Продажа (Уход)</option>
        <option value="Списание ЦБ (Уход)">Списание ЦБ (Уход)</option>
      </select>
      <input type="text" id="qty" placeholder="Количество (целое)" inputmode="decimal" />
      <input type="text" id="price" placeholder="Цена (точка или запятая)" inputmode="decimal" />
      <button class="btn" onclick="addOperation()">Добавить операцию</button>
      <div id="warn" class="warn"></div>
    </div>

    <div class="result-box" id="result">Зачисление ЦБ в HF: 0 шт.<br />Средняя цена (FIFO): 0.00 ₸</div>

    <button class="btn" style="width:100%; margin-top:8px; background:#0a8a78" onclick="toggleDetails()">Показать расчёты</button>
    <div id="details">Расчёты появятся здесь…</div>

    <div class="actions">
      <button class="btn" style="background:#e5e7eb; color:#111827" onclick="resetAll()">Очистить всё</button>
      <button class="btn" onclick="saveData()">Сохранить результат</button>
    </div>
  </div>

  <script>
    function toNumber(v) {
      if (typeof v === 'number') return v;
      if (!v) return NaN;
      const s = String(v).replace(/\s+/g, '').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }
    function round(n, d = 2) {const f = Math.pow(10, d);return Math.round((n + Number.EPSILON) * f) / f;}

    let operations = [];
    let calcDetails = '';

    function togglePriceField() {
      const type = document.getElementById('type').value;
      const price = document.getElementById('price');
      price.style.display = type === 'Списание ЦБ (Уход)' ? 'none' : 'block';
    }

    function showWarn(msg) {
      const w = document.getElementById('warn');
      w.textContent = msg;
      w.style.display = msg ? 'block' : 'none';
    }

    function addOperation() {
      try {
        showWarn('');
        const type = document.getElementById('type').value;
        const qty = Math.trunc(toNumber(document.getElementById('qty').value));
        const priceVal = toNumber(document.getElementById('price').value);

        if (!qty || qty <= 0) return showWarn('Введите корректное количество (целое число).');
        if (type !== 'Списание ЦБ (Уход)' && (!Number.isFinite(priceVal) || priceVal <= 0))
          return showWarn('Введите корректную цену (> 0).');

        operations.push({ type, qty, price: type === 'Списание ЦБ (Уход)' ? null : round(priceVal, 6) });
        renderTable();
        calculateFIFO();

        if (type === 'Списание ЦБ (Уход)') {
          document.getElementById('inputBlock').classList.add('hidden');
        }

        document.getElementById('qty').value = '';
        document.getElementById('price').value = '';
        document.getElementById('type').selectedIndex = 0;
        togglePriceField();
      } catch (e) {
        showWarn('Не удалось добавить операцию: ' + e.message);
      }
    }

    function renderTable() {
      const tbody = document.querySelector('#operationsTable tbody');
      tbody.innerHTML = '';
      operations.forEach((op, i) => {
        const tr = document.createElement('tr');
        tr.className = op.type.includes('Покупка') ? 'purchase' : (op.type.includes('Продажа') ? 'sale' : 'transfer');
        tr.innerHTML = `<td>${i + 1}</td><td>${op.type}</td><td>${op.qty}</td><td>${op.price ?? '-'}</td><td><button class="btn-del" onclick="deleteRow(${i})">×</button></td>`;
        tbody.appendChild(tr);
      });
      if (!operations.length) tbody.innerHTML = '<tr><td colspan="5" class="muted">Нет операций</td></tr>';
    }

    function deleteRow(i) {
      if (i < 0 || i >= operations.length) return;
      operations.splice(i, 1);
      renderTable();
      calculateFIFO();
      if (!operations.some(op => op.type === 'Списание ЦБ (Уход)')) {
        document.getElementById('inputBlock').classList.remove('hidden');
      }
    }

    function toggleDetails() {
      const el = document.getElementById('details');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function calculateFIFO() {
      try {
        calcDetails = '';
        let lots = [];
        let transferResult = null;

        for (const op of operations) {
          calcDetails += `Операция: ${op.type}, Кол-во: ${op.qty}, Цена: ${op.price ?? '-'}\n`;

          if (op.type === 'Покупка (Приход)') {
            lots.push({ qty: op.qty, price: op.price });
          } else if (op.type === 'Продажа (Уход)') {
            let remain = op.qty;
            let sellValue = 0, sellCost = 0;
            while (remain > 0 && lots.length) {
              const lot = lots[0];
              const use = Math.min(remain, lot.qty);
              sellValue += use * op.price;
              sellCost += use * lot.price;
              calcDetails += `  Списано ${use} по ${lot.price} (P/L на ед.: ${round(op.price - lot.price, 6)})\n`;
              lot.qty -= use;
              remain -= use;
              if (lot.qty === 0) lots.shift();
            }
            const profit = sellValue - sellCost;
            calcDetails += `  Себестоимость: ${round(sellCost,2)}, Выручка: ${round(sellValue,2)}, Прибыль/Убыток: ${round(profit,2)}\n`;
          } else if (op.type === 'Списание ЦБ (Уход)') {
            let remain = op.qty, value = 0, taken = 0;
            for (const lot of lots) {
              if (remain <= 0) break;
              const use = Math.min(remain, lot.qty);
              value += use * lot.price;
              taken += use;
              calcDetails += `  Списано ${use} по ${lot.price}\n`;
              lot.qty -= use;
              remain -= use;
            }
            const avgPrice = taken ? round(value / taken, 2) : 0;
            calcDetails += `  Себестоимость списанных: ${round(value,2)}\n`;
            transferResult = { qty: op.qty, avgPrice };
            calcDetails += `\n==> Списание ЦБ (Уход): ${op.qty} шт. Средняя цена (FIFO): ${avgPrice} ₸\n`;
          }

          const totalQtyNow = lots.reduce((s, l) => s + l.qty, 0);
          const totalValueNow = lots.reduce((s, l) => s + l.qty * l.price, 0);
          const avgNow = totalQtyNow ? round(totalValueNow / totalQtyNow, 2) : 0;
          calcDetails += `  Остаток после операции: ${totalQtyNow} шт. Средняя цена остатка: ${avgNow}\n\n`;

          lots = lots.filter(l => l.qty > 0);
        }

        const totalQty = lots.reduce((s, l) => s + l.qty, 0);
        const totalValue = lots.reduce((s, l) => s + l.qty * l.price, 0);
        const avg = totalQty ? round(totalValue / totalQty, 2) : 0;

        document.getElementById('result').innerHTML = transferResult
          ? `Списание ЦБ (Уход): ${transferResult.qty} шт.<br/>Средняя цена (FIFO): ${transferResult.avgPrice} ₸`
          : `Зачисление ЦБ в HF: ${totalQty} шт.<br/>Средняя цена (FIFO): ${avg} ₸`;

        document.getElementById('details').innerText = calcDetails.trim();
      } catch (e) {
        showWarn('Ошибка расчёта: ' + e.message);
      }
    }

    function resetAll() {
      operations = [];
      document.getElementById('details').innerText = '';
      document.getElementById('warn').style.display = 'none';
      document.getElementById('inputBlock').classList.remove('hidden');
      renderTable();
      document.getElementById('result').innerHTML = 'Зачисление ЦБ в HF: 0 шт.<br/>Средняя цена (FIFO): 0.00 ₸';
    }

    function saveData() {
      try {
        console.log('Сохранено:', JSON.stringify(operations, null, 2));
        alert('Данные сохранены в консоль.');
      } catch (e) {
        showWarn('Не удалось сохранить: ' + e.message);
      }
    }
  </script>
</body>
</html>
